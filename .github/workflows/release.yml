name: Release PyApp Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      embed_python:
        description: 'Embed Python distribution in binary'
        required: false
        type: boolean
        default: true

env:
  PYAPP_VERSION: "0.22.0"
  PYAPP_PROJECT_NAME: sysupdate
  PYAPP_EXEC_SPEC: "sysupdate.__main__:main"
  PYAPP_PYTHON_VERSION: "3.11"
  PYAPP_FULL_ISOLATION: "true"
  PYAPP_PIP_EXTERNAL: "true"

jobs:
  build-wheel:
    name: Build Python Wheel
    runs-on: ubuntu-latest
    outputs:
      wheel_name: ${{ steps.build.outputs.wheel_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Build wheel
        id: build
        run: |
          uv build --wheel
          WHEEL_NAME=$(ls dist/*.whl | head -1 | xargs basename)
          echo "wheel_name=${WHEEL_NAME}" >> "$GITHUB_OUTPUT"
          echo "Built wheel: ${WHEEL_NAME}"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel
          path: dist/*.whl
          retention-days: 1

  build-linux-x86_64:
    name: Build Linux x86_64 Binary
    runs-on: ubuntu-latest
    needs: build-wheel
    steps:
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: wheel

      - name: Download PyApp source
        run: |
          curl -Lo pyapp.tar.gz "https://github.com/ofek/pyapp/releases/download/v${PYAPP_VERSION}/source.tar.gz"
          tar -xzf pyapp.tar.gz
          mv pyapp-v${PYAPP_VERSION} pyapp

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build binary
        env:
          PYAPP_PROJECT_VERSION: ${{ inputs.version }}
          PYAPP_PROJECT_PATH: ${{ github.workspace }}/wheel/${{ needs.build-wheel.outputs.wheel_name }}
          PYAPP_DISTRIBUTION_EMBED: ${{ inputs.embed_python && '1' || '0' }}
        run: |
          cd pyapp
          cargo build --release
          cp target/release/pyapp ../sysupdate-linux-x86_64

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-x86_64
          path: sysupdate-linux-x86_64
          retention-days: 1

  build-linux-aarch64:
    name: Build Linux aarch64 Binary
    runs-on: ubuntu-latest
    needs: build-wheel
    steps:
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: wheel

      - name: Download PyApp source
        run: |
          curl -Lo pyapp.tar.gz "https://github.com/ofek/pyapp/releases/download/v${PYAPP_VERSION}/source.tar.gz"
          tar -xzf pyapp.tar.gz
          mv pyapp-v${PYAPP_VERSION} pyapp

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary
        env:
          PYAPP_PROJECT_VERSION: ${{ inputs.version }}
          PYAPP_PROJECT_PATH: ${{ github.workspace }}/wheel/${{ needs.build-wheel.outputs.wheel_name }}
          PYAPP_DISTRIBUTION_EMBED: ${{ inputs.embed_python && '1' || '0' }}
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cd pyapp
          cargo build --release --target aarch64-unknown-linux-gnu
          cp target/aarch64-unknown-linux-gnu/release/pyapp ../sysupdate-linux-aarch64

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-aarch64
          path: sysupdate-linux-aarch64
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-wheel, build-linux-x86_64, build-linux-aarch64]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp artifacts/binary-linux-x86_64/sysupdate-linux-x86_64 release/
          cp artifacts/binary-linux-aarch64/sysupdate-linux-aarch64 release/
          cp artifacts/wheel/*.whl release/
          chmod +x release/sysupdate-linux-*

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: sysupdate v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            release/sysupdate-linux-x86_64
            release/sysupdate-linux-aarch64
            release/*.whl
            release/SHA256SUMS.txt
